# This file was generated by the excavator check 'excavator/manage-circleci' as specified in .circleci/template.sh.
# To request a modification to the general template, file an issue on Excavator.
# To manually manage the CircleCI configuration for this project, remove the .circleci/template.sh file.

version: 2.1

orbs:
  go-jobs: palantir/go-jobs@0.8.0

image-version: &image-version "cimg/go:1.25.1-browsers"

executors:
  standard-executor:
    docker:
      - image: *image-version
    working_directory: /home/circleci/go/src/github.com/palantir/godel
    resource_class: medium
  standard-executor-pkg-products-verify-test:
    docker:
      - image: *image-version
    working_directory: /home/circleci/go/src/github.com/palantir/godel/pkg/products/v2

# Filter that matches all tags (will run on every build).
all-tags-filter: &all-tags-filter
  filters:
    tags:
      only: /.*/

# Filter that matches any branch besides primary branch and ignores all tags except for release candidates
pull-request-filter: &pull-request-filter
  filters:
    tags:
      only: /.*-rc.*/
    branches:
      ignore:
        - develop

requires_jobs: &requires_jobs
  - build
  - verify
  - test
  - dist
  - integration-test
  - pkg-products-verify-test

workflows:
  version: 2
  verify:
    jobs:
      - go-jobs/godel_build:
          name: "build"
          executor: "standard-executor"
          <<: *all-tags-filter
      - go-jobs/godel_verify:
          name: "verify"
          executor: "standard-executor"
          skip_tests: true
          requires:
            - build
          <<: *all-tags-filter
      - go-jobs/godel_test:
          name: "test"
          executor: "standard-executor"
          test_flags: "--tags=none"
          requires:
            - build
          <<: *all-tags-filter
      - go-jobs/godel_test:
          name: "integration-test"
          executor: "standard-executor"
          test_flags: "--tags=integration"
          requires:
            - build
          <<: *all-tags-filter
      - go-jobs/godel_verify:
          name: "pkg-products-verify-test"
          executor: "standard-executor-pkg-products-verify-test"
          setup_steps:
            - go-jobs/default_setup_steps:
                checkout_steps:
                  - checkout:
                      path: /home/circleci/go/src/github.com/palantir/godel
          <<: *all-tags-filter
      - go-jobs/godel_dist:
          name: "dist"
          executor: "standard-executor"
          requires:
            - build
          <<: *all-tags-filter
      - go-jobs/circle_all:
          name: "circle-all"
          image: "busybox:1.36.1"
          requires: *requires_jobs
          <<: *pull-request-filter
